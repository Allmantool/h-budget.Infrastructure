global:
  scrape_interval: 20s
  scrape_timeout: 15s
  evaluation_interval: 20s

  external_labels:
    cluster: "home-budget"
    environment: "local"
    monitoring: "prometheus"

# Alertmanager wiring (ready, but safe if not running yet)
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets:
#             - "alertmanager:9093"

scrape_configs:

  # =========================
  # API SERVICES
  # =========================
  - job_name: "apis"
    metrics_path: /metrics
    scrape_interval: 20s
    honor_labels: true

    static_configs:
      - targets: ["gateway-api:80"]
        labels:
          component: "api"
          service: "gateway-api"
          stack: "home-budget"

      - targets: ["homebudget-rates-api:80"]
        labels:
          component: "api"
          service: "rates-api"
          stack: "home-budget"

      - targets: ["homebudget-accounting-api:80"]
        labels:
          component: "api"
          service: "accounting-api"
          stack: "home-budget"

  # =========================
  # ACCOUNTING WORKERS (Docker SD)
  # =========================
  - job_name: "accounting-workers"
    metrics_path: /metrics
    scrape_interval: 30s
    honor_labels: true

    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 15s

    relabel_configs:
      # Keep only accounting worker containers
      - source_labels: [__meta_docker_container_name]
        regex: .*/homebudget-accounting-payments-consumer-worker.*
        action: keep

      # Build target address correctly
      - source_labels: [__meta_docker_container_ip]
        regex: (.+)
        target_label: __address__
        replacement: "$1:80"

      # Clean instance label
      - source_labels: [__meta_docker_container_name]
        target_label: instance

      # Static labels
      - target_label: component
        replacement: "worker"

      - target_label: service
        replacement: "accounting-payments-consumer"

      - target_label: stack
        replacement: "home-budget"

  # =========================
  # CONTAINER & HOST METRICS
  # =========================
  - job_name: "cadvisor"
    scrape_interval: 15m
    scrape_timeout: 10m
    static_configs:
      - targets: ["cadvisor:8080"]
        labels:
          component: "container"
          stack: "home-budget"

    metric_relabel_configs:
      # Reduce cardinality
      - source_labels: [__name__]
        regex: "container_fs_.*"
        action: drop

  - job_name: "node-exporter"
    scrape_interval: 45s
    scrape_timeout: 35s
    static_configs:
      - targets: ["node-exporter:9100"]
        labels:
          component: "node"
          stack: "home-budget"

  # =========================
  # DATABASE EXPORTERS
  # =========================
  - job_name: "mongodb"
    scrape_interval: 60s
    scrape_timeout: 30s
    static_configs:
      - targets: ["mongo-db-exporter:9216"]
        labels:
          component: "database"
          service: "mongodb"
          stack: "home-budget"

  - job_name: "mssql"
    scrape_interval: 300s
    scrape_timeout: 180s
    static_configs:
      - targets: ["mssql-exporter:4000"]
        labels:
          component: "database"
          service: "mssql"
          stack: "home-budget"

  - job_name: "redis"
    scrape_interval: 15s
    static_configs:
      - targets: ["redis-exporter:9121"]
        labels:
          component: "database"
          service: "redis"
          stack: "home-budget"

  # =========================
  # INFRASTRUCTURE
  # =========================
  - job_name: "nginx"
    scrape_interval: 20s
    static_configs:
      - targets: ["nginx-exporter:9113"]
        labels:
          component: "ingress"
          service: "nginx"
          stack: "home-budget"

  - job_name: "kafka"
    scrape_interval: 30s
    scrape_timeout: 20s
    static_configs:
      - targets: ["kafka-exporter:9308"]
        labels:
          component: "messaging"
          service: "kafka"
          stack: "home-budget"

  - job_name: "eventstoredb"
    scrape_interval: 30s
    static_configs:
      - targets: ["event-store-db-exporter:9448"]
        labels:
          component: "eventstore"
          service: "eventstoredb"
          stack: "home-budget"

  # =========================
  # OBSERVABILITY STACK
  # =========================
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
        labels:
          component: "monitoring"
          service: "prometheus"
          stack: "home-budget"

  - job_name: "grafana"
    scrape_interval: 30s
    static_configs:
      - targets: ["grafana:3000"]
        labels:
          component: "monitoring"
          service: "grafana"
          stack: "home-budget"

  - job_name: "loki"
    scrape_interval: 30s
    static_configs:
      - targets: ["loki:3100"]
        labels:
          component: "logging"
          service: "loki"
          stack: "home-budget"

  - job_name: "tempo"
    scrape_interval: 30s
    static_configs:
      - targets: ["tempo:3200"]
        labels:
          component: "tracing"
          service: "tempo"
          stack: "home-budget"

  - job_name: "alloy"
    scrape_interval: 30s
    static_configs:
      - targets: ["gf-alloy:12345"]
        labels:
          component: "agent"
          service: "alloy"
          stack: "home-budget"
